# Convex Guidelines for React Native / Expo Apps

## ⚠️ CRITICAL: This file is for REACT NATIVE apps ⚠️

There are TWO types of files when using Convex:
1. **Server files** (convex/*.ts) - Run on Convex cloud servers
2. **Client files** (app/*.tsx, components/*.tsx) - Run in React Native app

Using the WRONG imports will cause INSTANT APP CRASH!

---

## IMPORT RULES (MEMORIZE THIS)

### In React Native files (app/, components/, screens/, hooks/, lib/):
```typescript
// ✅ ONLY THESE IMPORTS ARE ALLOWED:
import { useQuery, useMutation, useAction, ConvexProvider, ConvexReactClient } from "convex/react";
import { api } from "../convex/_generated/api";

// ❌ NEVER IMPORT THESE - WILL CRASH:
// import { anything } from "convex/server";     // CRASH!
// import { v } from "convex/values";            // CRASH!
// import { query, mutation } from "convex/server"; // CRASH!
```

### In Convex server files (convex/*.ts only):
```typescript
// ✅ These are fine in convex/ folder:
import { query, mutation, action } from "./_generated/server";
import { v } from "convex/values";
import { defineSchema, defineTable } from "convex/server";
```

---

## REACT NATIVE CLIENT PATTERNS

### Setting up ConvexProvider (app/_layout.tsx):
```typescript
import { ConvexProvider, ConvexReactClient } from "convex/react";
import { Stack } from "expo-router";

const convex = new ConvexReactClient(process.env.EXPO_PUBLIC_CONVEX_URL!, {
  unsavedChangesWarning: false, // Required for React Native
});

export default function RootLayout() {
  return (
    <ConvexProvider client={convex}>
      <Stack />
    </ConvexProvider>
  );
}
```

### Using queries in components:
```typescript
import { useQuery } from "convex/react";
import { api } from "../convex/_generated/api";
import { View, Text, FlatList, ActivityIndicator } from "react-native";

export default function TodoList() {
  const todos = useQuery(api.todos.list);

  // Always handle loading state
  if (todos === undefined) {
    return <ActivityIndicator />;
  }

  return (
    <FlatList
      data={todos}
      keyExtractor={(item) => item._id}
      renderItem={({ item }) => <Text>{item.text}</Text>}
    />
  );
}
```

### Using mutations in components:
```typescript
import { useMutation } from "convex/react";
import { api } from "../convex/_generated/api";

export default function AddTodo() {
  const createTodo = useMutation(api.todos.create);

  const handleAdd = async () => {
    await createTodo({ text: "New todo" });
  };

  return (
    <Pressable onPress={handleAdd}>
      <Text>Add Todo</Text>
    </Pressable>
  );
}
```

### Passing document IDs:
```typescript
// Document IDs use _id (with underscore), not id
const toggleTodo = useMutation(api.todos.toggle);

// Pass the _id from the document
<Pressable onPress={() => toggleTodo({ id: item._id })}>
```

---

## CONVEX SERVER FILE PATTERNS (convex/*.ts)

### Schema definition (convex/schema.ts):
```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  todos: defineTable({
    text: v.string(),
    completed: v.boolean(),
    createdAt: v.number(),
  }),
});
```

### Query function (convex/todos.ts):
```typescript
import { query } from "./_generated/server";
import { v } from "convex/values";

export const list = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db.query("todos").order("desc").collect();
  },
});
```

### Mutation function (convex/todos.ts):
```typescript
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export const create = mutation({
  args: { text: v.string() },
  handler: async (ctx, args) => {
    await ctx.db.insert("todos", {
      text: args.text,
      completed: false,
      createdAt: Date.now(),
    });
  },
});

export const toggle = mutation({
  args: { id: v.id("todos") },
  handler: async (ctx, args) => {
    const todo = await ctx.db.get(args.id);
    if (todo) {
      await ctx.db.patch(args.id, { completed: !todo.completed });
    }
  },
});

export const remove = mutation({
  args: { id: v.id("todos") },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.id);
  },
});
```

---

## COMMON VALIDATORS (for convex/*.ts files only)

| Type | Validator | Example |
|------|-----------|---------|
| String | `v.string()` | `"hello"` |
| Number | `v.number()` | `42`, `3.14` |
| Boolean | `v.boolean()` | `true`, `false` |
| Document ID | `v.id("tableName")` | `v.id("todos")` |
| Optional | `v.optional(v.string())` | `"hello"` or `undefined` |
| Array | `v.array(v.string())` | `["a", "b"]` |
| Object | `v.object({ key: v.string() })` | `{ key: "value" }` |
| Union | `v.union(v.string(), v.number())` | `"hello"` or `42` |
| Literal | `v.literal("active")` | `"active"` |
| Null | `v.null()` | `null` |

---

## FILE STORAGE (for images/files)

### Server-side (convex/files.ts):
```typescript
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const generateUploadUrl = mutation({
  args: {},
  handler: async (ctx) => {
    return await ctx.storage.generateUploadUrl();
  },
});

export const getFileUrl = query({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, args) => {
    return await ctx.storage.getUrl(args.storageId);
  },
});
```

### Client-side (React Native component):
```typescript
import { useMutation } from "convex/react";
import { api } from "../convex/_generated/api";
import * as ImagePicker from "expo-image-picker";

function ImageUploader() {
  const generateUploadUrl = useMutation(api.files.generateUploadUrl);

  const uploadImage = async () => {
    const result = await ImagePicker.launchImageLibraryAsync({
      base64: false,
      quality: 0.8,
    });

    if (result.canceled) return;

    const uploadUrl = await generateUploadUrl();

    const response = await fetch(uploadUrl, {
      method: "POST",
      headers: { "Content-Type": result.assets[0].mimeType || "image/jpeg" },
      body: await fetch(result.assets[0].uri).then(r => r.blob()),
    });

    const { storageId } = await response.json();
    // Save storageId to your database
  };
}
```

---

## DEPLOYMENT

After writing/editing convex/ files, deploy with:
```bash
npx convex dev --once --typecheck=disable
```

The app won't see changes until you deploy!

---

## QUICK CHECKLIST

Before writing Convex code, ask yourself:

1. **Am I in a convex/*.ts file or a React Native file?**
   - convex/*.ts → Can use `convex/server`, `convex/values`
   - Anywhere else → Can ONLY use `convex/react` and `_generated/api`

2. **Did I handle the loading state?**
   - `useQuery` returns `undefined` while loading

3. **Am I using `_id` for document IDs?**
   - Convex uses `_id`, not `id`

4. **Did I deploy after making server changes?**
   - Run `npx convex dev --once --typecheck=disable`
